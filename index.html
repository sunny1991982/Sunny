<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Sunny Shop - Store</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div id="login-section" class="container" style="max-width: 400px; margin-top: 100px;">
        <div class="card">
            <h2 style="text-align:center"><i class="fas fa-sun"></i> Sunny Shop</h2>
            <input type="text" id="user-name" placeholder="ชื่อผู้ใช้งาน">
            <input type="password" id="user-pass" placeholder="รหัสผ่าน">
            <button class="btn btn-primary" onclick="handleAuth()">เข้าสู่ระบบ / สมัครใหม่</button>
        </div>
    </div>

    <div id="main-section" class="hidden">
        <header>
            <div><i class="fas fa-user-circle"></i> <span id="display-user"></span></div>
            <div>
                <span class="credit-badge">฿ <span id="display-credit">0</span></span>
                <button class="btn" style="width:auto; margin-left:10px; background:#475569; color:white;" onclick="location.reload()">ออก</button>
            </div>
        </header>
        <div class="container">
            <div class="card" style="border-left: 5px solid #10b981;">
                <h4><i class="fas fa-ticket-alt"></i> ใช้โค้ดรับรางวัล</h4>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="code-input" placeholder="ใส่โค้ดที่นี่" style="margin:0">
                    <button class="btn btn-primary" style="width:120px;" onclick="redeem()">ตกลง</button>
                </div>
            </div>
            <h3>รายการสินค้าทั้งหมด</h3>
            <div id="shop-items" class="grid"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyB2MNzL1-w1AxW5taQvyvTFJO4GkL4ucis",
            authDomain: "sunny-shop-fc134.firebaseapp.com",
            projectId: "sunny-shop-fc134",
            storageBucket: "sunny-shop-fc134.firebasestorage.app",
            messagingSenderId: "126433516060",
            appId: "1:126433516060:web:dbc327c35a330a06271dd9",
            databaseURL: "https://sunny-shop-fc134-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentU = "";

        window.handleAuth = async () => {
            const u = document.getElementById('user-name').value.trim();
            const p = document.getElementById('user-pass').value.trim();
            if(!u || !p) return alert("กรุณากรอกข้อมูล");
            const uRef = ref(db, 'users/' + u);
            const snap = await get(uRef);
            if(snap.exists()){
                if(snap.val().password === p) startSession(u);
                else alert("รหัสผ่านผิด");
            } else {
                await set(uRef, { password: p, credit: 0 });
                alert("สมัครสมาชิกใหม่สำเร็จ!");
                startSession(u);
            }
        };

        function startSession(u) {
            currentU = u;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('display-user').innerText = u;
            onValue(ref(db, `users/${u}/credit`), s => document.getElementById('display-credit').innerText = (s.val() || 0).toLocaleString());
            loadItems();
        }

        function loadItems() {
            onValue(ref(db, 'items'), s => {
                const cont = document.getElementById('shop-items');
                cont.innerHTML = "";
                Object.entries(s.val() || {}).forEach(([id, item]) => {
                    cont.innerHTML += `<div class="item-card"><h4>${item.name}</h4><p style="color:#fbbf24; font-weight:bold;">฿${item.price.toLocaleString()}</p><button class="btn btn-primary" onclick="buy('${id}', ${item.price})">ซื้อเลย</button></div>`;
                });
            });
        }

        window.buy = async (id, price) => {
            const cRef = ref(db, `users/${currentU}/credit`);
            const s = await get(cRef);
            const currentBalance = s.val() || 0;
            if(currentBalance >= price) {
                if(confirm("ยืนยันการซื้อ?")) {
                    await set(cRef, currentBalance - price);
                    alert("ซื้อสำเร็จ! ระบบหักเครดิตแล้ว");
                }
            } else alert("เครดิตไม่พอ กรุณาติดต่อเจ้าของร้าน");
        };

        window.redeem = async () => {
            const code = document.getElementById('code-input').value.trim();
            const cRef = ref(db, 'codes/' + code);
            const s = await get(cRef);
            if(s.exists()) {
                const data = s.val();
                if(data.usedCount < data.limit) {
                    const uCRef = ref(db, `users/${currentU}/credit`);
                    const userSnap = await get(uCRef);
                    await update(cRef, { usedCount: data.usedCount + 1 });
                    await set(uCRef, (userSnap.val() || 0) + data.reward);
                    alert(`สำเร็จ! ได้รับ ฿${data.reward}`);
                    document.getElementById('code-input').value = "";
                } else alert("โค้ดนี้ถูกใช้ครบจำนวนแล้ว");
            } else alert("ไม่พบโค้ดนี้");
        };
    </script>
</body>
    </html>
                
